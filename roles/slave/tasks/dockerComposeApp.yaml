- name: installisation
  apt:
    name:
      - certbot
      - default-jre

- name: install docker-compose
  get_url:
    url: https://github.com/docker/compose/releases/download/1.25.1-rc1/docker-compose-Linux-x86_64
    dest: /usr/local/bin/docker-compose
    mode: 'u+x,g+x'

- name: generation of serts
  shell: certbot certonly --standalone -d slave.nikitasdomain.tk --staple-ocsp -m darty@nikitasdomain.tk --agree-tos


- name: create folder /opt/application
  ansible.builtin.file:
    path: /opt/application
    owner: 1000
    group: 1000
    state: directory
    mode: '0755'


#- name: clone of branch
#  ansible.builtin.git:
#    repo: https://github.com/not-only-yours/videoAndChatApp.git
#    dest: /opt/application
#    version: main

- name: Create a network
  docker_network:
    name: "my-pre-existing-network"

- name: create folder /opt/nginx
  ansible.builtin.file:
    path: /opt/nginx
    owner: 1000
    group: 1000
    state: directory
    mode: '0755'

- name: copy nginx config file
  copy: src=/Users/nikita_dir/Documents/projects/NikitaAnsible/roles/slave/files/vhost.conf dest=/opt/nginx/vhost.conf

- name: pull nginx image
  docker_image:
    name: nginx:stable
    source: pull

- name: deploy nginx docker container
  docker_container:
    name: "nginx"
    image: "nginx:stable"
    detach: yes
    ports:
      - "80:80"
      - "443:443"
    networks:
      - name: "my-pre-existing-network"

    volumes:
      - /opt/nginx/vhost.conf:/etc/nginx/conf.d/vhost.conf
      - /etc/letsencrypt/live/slave.nikitasdomain.tk/fullchain.pem:/etc/letsencrypt/live/slave.nikitasdomain.tk/slave.nikitasdomain.tk.crt
      - /etc/letsencrypt/live/slave.nikitasdomain.tk/privkey.pem:/etc/letsencrypt/live/slave.nikitasdomain.tk/slave.nikitasdomain.tk.key